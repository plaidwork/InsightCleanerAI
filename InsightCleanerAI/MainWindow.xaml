<Window x:Class="InsightCleanerAI.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:viewModels="clr-namespace:InsightCleanerAI.ViewModels"
        xmlns:models="clr-namespace:InsightCleanerAI.Models"
        xmlns:sys="clr-namespace:System;assembly=mscorlib"
        xmlns:infra="clr-namespace:InsightCleanerAI.Infrastructure"
        xmlns:res="clr-namespace:InsightCleanerAI.Resources"
        mc:Ignorable="d"
        Title="{x:Static res:Strings.AppTitle}"
        Height="720"
        Width="1200">
    <Window.DataContext>
        <viewModels:MainViewModel />
    </Window.DataContext>

    <Window.Resources>
        <ObjectDataProvider x:Key="PrivacyModes"
                            MethodName="GetValues"
                            ObjectType="{x:Type sys:Enum}">
            <ObjectDataProvider.MethodParameters>
                <x:Type TypeName="models:PrivacyMode" />
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>
        <ObjectDataProvider x:Key="AiModes"
                            MethodName="GetValues"
                            ObjectType="{x:Type sys:Enum}">
            <ObjectDataProvider.MethodParameters>
                <x:Type TypeName="models:AiMode" />
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>
        <infra:MarkdownToFlowDocumentConverter x:Key="MarkdownToFlowDocumentConverter" />
    </Window.Resources>

    <DockPanel>
                <Menu DockPanel.Dock="Top">
            <MenuItem Header="{x:Static res:Strings.MenuFile}">
                <MenuItem Header="{x:Static res:Strings.MenuExit}"
                          Click="ExitMenuItem_Click" />
            </MenuItem>
            <MenuItem Header="{x:Static res:Strings.MenuSettings}">
                <MenuItem Header="{x:Static res:Strings.MenuOpenSettings}"
                          Click="OpenSettingsMenu_Click" />
                <MenuItem Header="{x:Static res:Strings.BlacklistMenuItem}"
                          Click="OpenBlacklistMenu_Click" />
            </MenuItem>
        </Menu>

        <Border DockPanel.Dock="Top"
                Padding="12"
                Background="{DynamicResource {x:Static SystemColors.ControlLightBrushKey}}">
            <DockPanel>
                <Grid DockPanel.Dock="Top">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    <TextBlock Grid.Column="0"
                               Margin="0,0,8,0"
                               VerticalAlignment="Center"
                               Text="{x:Static res:Strings.RootPathLabel}" />
                    <TextBox Grid.Column="1"
                             MinWidth="420"
                             Text="{Binding RootPath, UpdateSourceTrigger=PropertyChanged}" />
                    <StackPanel Grid.Column="2"
                                Orientation="Horizontal"
                                Margin="8,0,0,0">
                        <Button Content="{x:Static res:Strings.BrowseButton}"
                                Padding="18,4"
                                Margin="0,0,8,0"
                                Click="BrowseButton_Click" />
                        <Button Content="{x:Static res:Strings.ScanButton}"
                                Padding="18,4"
                                Margin="0,0,8,0"
                                Click="ScanButton_Click">
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="IsEnabled" Value="True" />
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsScanning}" Value="True">
                                            <Setter Property="IsEnabled" Value="False" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>
                        <Button Content="{x:Static res:Strings.CancelButton}"
                                Padding="18,4"
                                Click="CancelButton_Click"
                                IsEnabled="{Binding IsScanning}" />
                    </StackPanel>
                </Grid>

                <StackPanel Margin="0,12,0,0">
                    <TextBlock Text="{x:Static res:Strings.ProgressLabel}"
                               FontWeight="SemiBold" />
                    <ProgressBar Height="10"
                                 Minimum="0"
                                 Maximum="1"
                                 Value="{Binding ProgressValue, Mode=OneWay}" />
                </StackPanel>
            </DockPanel>
        </Border>

        <StatusBar DockPanel.Dock="Bottom">
            <StatusBarItem>
                <TextBlock Text="{Binding StatusMessage}" />
            </StatusBarItem>
            <StatusBarItem DockPanel.Dock="Right">
                <TextBlock Text="{Binding AppVersion}"
                           Foreground="DimGray" />
            </StatusBarItem>
        </StatusBar>

        <Grid Margin="12">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="2*" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <TreeView ItemsSource="{Binding Nodes}"
                      SelectedItemChanged="TreeView_OnSelectedItemChanged"
                      MouseDoubleClick="TreeView_OnMouseDoubleClick"
                      PreviewKeyDown="TreeView_OnPreviewKeyDown"
                      PreviewMouseRightButtonDown="TreeView_OnPreviewMouseRightButtonDown">
                <TreeView.Resources>
                    <ContextMenu x:Key="NodeContextMenu">
                        <MenuItem Header="{x:Static res:Strings.TreeContextDelete}"
                                  Click="DeleteMenuItem_Click" />
                    </ContextMenu>
                </TreeView.Resources>
                <TreeView.ItemContainerStyle>
                    <Style TargetType="TreeViewItem">
                        <Setter Property="ContextMenu" Value="{StaticResource NodeContextMenu}" />
                    </Style>
                </TreeView.ItemContainerStyle>
                <TreeView.ItemTemplate>
                    <HierarchicalDataTemplate DataType="{x:Type viewModels:StorageNodeViewModel}"
                                              ItemsSource="{Binding Children}">
                        <StackPanel Orientation="Horizontal" Margin="0,2">
                            <TextBlock Text="{Binding Name}"
                                       FontWeight="SemiBold" />
                            <TextBlock Text="{Binding SizeDisplay}"
                                       Foreground="DimGray"
                                       Margin="8,0,0,0" />
                            <TextBlock Text="{Binding ClassificationLabel}"
                                       Foreground="DodgerBlue"
                                       Margin="8,0,0,0" />
                            <TextBlock Text="{Binding StatusBadge}"
                                       Foreground="OrangeRed"
                                       Margin="4,0,0,0"
                                       FontWeight="Bold" />
                        </StackPanel>
                    </HierarchicalDataTemplate>
                </TreeView.ItemTemplate>
            </TreeView>

            <Border Grid.Column="1"
                    Margin="12,0,0,0"
                    Padding="12"
                    BorderBrush="LightGray"
                    BorderThickness="1">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel>
                        <TextBlock Text="{x:Static res:Strings.NodeDetailsTitle}"
                                   FontSize="18"
                                   FontWeight="Bold"
                                   Margin="0,0,0,8" />
                        <TextBlock Text="{x:Static res:Strings.PathLabel}"
                                   FontWeight="SemiBold" />
                        <TextBlock Text="{Binding SelectedNode.DisplayPath, TargetNullValue={x:Static res:Strings.UnselectedPlaceholder}}"
                                   Margin="0,0,0,8"
                                   TextWrapping="Wrap" />

                        <TextBlock Text="{x:Static res:Strings.SizeLabel}"
                                   FontWeight="SemiBold" />
                        <TextBlock Text="{Binding SelectedNode.SizeDisplay, TargetNullValue={x:Static res:Strings.DefaultPlaceholder}}"
                                   Margin="0,0,0,8" />

                        <TextBlock Text="{x:Static res:Strings.ClassificationLabel}"
                                   FontWeight="SemiBold" />
                        <TextBlock Text="{Binding SelectedNode.ClassificationLabel, TargetNullValue={x:Static res:Strings.DefaultPlaceholder}}"
                                   Margin="0,0,0,8" />

                        <TextBlock Text="{x:Static res:Strings.AiInsightLabel}"
                                   FontWeight="SemiBold" />
                        <TextBlock Text="{Binding SelectedNode.StatusBadge}"
                                   Foreground="OrangeRed"
                                   FontWeight="Bold"
                                   Margin="0,0,0,4" />
                        <FlowDocumentScrollViewer IsToolBarVisible="False"
                                                   IsHitTestVisible="False"
                                                   VerticalScrollBarVisibility="Hidden"
                                                   Background="Transparent"
                                                   Document="{Binding SelectedNode.Insight, Converter={StaticResource MarkdownToFlowDocumentConverter}}" />

                        <Button Content="删除文件/文件夹"
                                Margin="0,16,0,0"
                                Padding="12,6"
                                Click="DeleteNodeButton_Click"
                                Background="#FFEB4D4D"
                                Foreground="White"
                                FontWeight="SemiBold">
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="IsEnabled" Value="True" />
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding SelectedNode}" Value="{x:Null}">
                                            <Setter Property="IsEnabled" Value="False" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>
                    </StackPanel>
                </ScrollViewer>
            </Border>
        </Grid>
    </DockPanel>
</Window>

